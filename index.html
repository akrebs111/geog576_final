<!--Created by Alex Krebs-->
<!--Geog576 Final Project-->
<!--Resource Request Full Stack Application-->

<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Resource Request Dashboard</title>
<style>
body { margin: 0; font-family: Arial, sans-serif; }

/* tab style */
.tab { display: flex; flex-wrap: wrap; background: #0079c1; }
.tab button { flex: 1 1 auto; background: inherit; border: none; outline: none; cursor: pointer; padding: 14px 12px; color: white; font-size: 1em; }
.tab button.active { background: #005a87; }
.tab button:hover {
  background: #004b6b; /* darker blue on hover */
}
.survey-btn, .help-btn { flex: 1 1 auto; margin: 4px 2px; font-size: 1em; }

.tabcontent { display: none; width: 100%; position: relative; }
.mapContainer { height: calc(100vh - 52px); width: 100%; }

/* count indcators */
.countBoxes {
  position: absolute;
  bottom: 0;
  left: 0;
  width: 100%;
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  background: rgba(255,255,255,0.9);
  padding: 12px 0;
  box-shadow: 0 -2px 4px rgba(0,0,0,0.3);
  font-weight: bold;
  font-size: 1em;
}
.countBox {
  color: white;
  padding: 12px 16px;
  border-radius: 6px;
  text-align: center;
  margin: 4px;
  min-width: 120px;
}

/* assigned filter */
#assignedFilter {
  position: absolute;
  top: 10px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 1000;
  background: white;
  padding: 12px;
  border-radius: 6px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.3);
  font-size: 1em;
}

/* splash popup */
#splashPopup { display: none; position: fixed; z-index: 2000; inset: 0; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; padding: 12px; }
#splashPopup.active { display: flex; }
#splashContent { background: white; padding: 20px; border-radius: 8px; max-width: 95%; box-shadow: 0 0 15px rgba(0,0,0,0.3); font-size: 1em; line-height: 1.4; }
#splashCloseBtn { position: absolute; top: 8px; right: 8px; background: #bc143c; border: none; color: white; font-size: 1.2em; cursor: pointer; border-radius: 50%; width: 32px; height: 32px; line-height: 30px; text-align: center; }

/* mobile friendly adjustments */
@media (max-width: 768px) {
  .tab button, .survey-btn, .help-btn { font-size: 0.9em; padding: 12px 10px; }
  .countBoxes { flex-direction: column; font-size: 0.9em; }
  #assignedFilter { font-size: 0.9em; padding: 10px; width: 90%; }
}
</style>

<link rel="stylesheet" href="https://js.arcgis.com/4.26/esri/themes/light/main.css" />
<script src="https://js.arcgis.com/4.26/"></script>
</head>

<body>

<div class="tab">
  <button class="tablink active" onclick="openTab(event, 'dashboard')">Resource Request Dashboard</button>
  <button class="tablink" onclick="openTab(event, 'pending')">Pending Review</button>
  <button class="tablink" onclick="openTab(event, 'assigned')">Assigned</button>
  <button class="tablink" onclick="openTab(event, 'completed')">Completed</button>
  <button class="survey-btn" onclick="window.open('https://survey123.arcgis.com/share/14b60521f4b843239d951fa1ce3a6f57','_blank')">Resource Request Form</button>
  <button class="help-btn" id="helpButton">Help</button>
</div>

<!-- resource request dashboard tab -->
<div id="dashboard" class="tabcontent" style="display:block;">
  <div id="viewDiv1" class="mapContainer"></div>
  <div id="countBoxesDashboard" class="countBoxes"></div>
</div>

<!-- pending review tab -->
<div id="pending" class="tabcontent">
  <div id="viewDiv2" class="mapContainer"></div>
  <div id="countBoxesPending" class="countBoxes"></div>
</div>

<!-- assigned tab -->
<div id="assigned" class="tabcontent">
  <div id="viewDiv3" class="mapContainer"></div>
  <div id="assignedFilter">
    <label for="assignedSelect">Select EOC Position:</label>
    <select id="assignedSelect">
      <option value="">-- All --</option>
    </select>
  </div>
</div>

<!-- completed tab -->
<div id="completed" class="tabcontent">
  <div id="viewDiv4" class="mapContainer"></div>
  <div id="countBoxesCompleted" class="countBoxes"></div>
</div>

<!-- splash popup -->
<div id="splashPopup" role="dialog" aria-modal="true" aria-labelledby="splashTitle" tabindex="-1">
  <div id="splashContent">
    <button id="splashCloseBtn" aria-label="Close Help">&times;</button>
    <h2 id="splashTitle" style="text-align:center;">Welcome to the Resource Request Tracking, Assignment, and Approval Application</h2>
    <ul>
      <li>Use the <strong>Resource Request Dashboard</strong> to view requested resources.</li>
      <li>The <strong>Pending Review</strong> tab is for EOC Resource section members to verify and assign resource requests.</li>
      <li>The <strong>Assigned</strong> tab allows EOC positions to filter their position and edit any resource requests they may be assigned.</li>
      <li>The <strong>Completed</strong> tab tracks any resources that have been completed, approved, or denied.</li>
      <li>Resource requests can be manually entered by clicking the <strong>Resource Request Form</strong> button.</li>
    </ul>
  </div>
</div>

<script>
function openTab(evt, tabName) {
  document.querySelectorAll(".tabcontent").forEach(div => div.style.display = 'none');
  document.querySelectorAll(".tablink").forEach(btn => btn.classList.remove('active'));
  document.getElementById(tabName).style.display = 'block';
  evt.currentTarget.classList.add('active');

  // Safely resize the view if it exists
  const view = views[tabName];
  if (view && typeof view.resize === "function") {
    view.resize();
  }
}

//splash popup show/hide
const splashPopup = document.getElementById("splashPopup");
const helpButton = document.getElementById("helpButton");
const splashCloseBtn = document.getElementById("splashCloseBtn");

//splash on page load
splashPopup.classList.add("active");
splashPopup.focus();

helpButton.addEventListener("click", () => {
  splashPopup.classList.add("active");
  splashPopup.focus();
});
splashCloseBtn.addEventListener("click", () => {
  splashPopup.classList.remove("active");
});
splashPopup.addEventListener("click", (evt) => {
  if(evt.target === splashPopup){
    splashPopup.classList.remove("active");
  }
});

require([
  "esri/Map",
  "esri/views/MapView",
  "esri/layers/FeatureLayer",
  "esri/widgets/Editor"
], function(Map, MapView, FeatureLayer, Editor){

  window.views = {};

  /* county boundary */
  const countyBoundaryRenderer = {
    type: "simple",
    symbol: { type: "simple-fill", color: [0,0,0,0], outline:{color:"black", width:0.5, style:"dash"} }
  };
  const countyLabelClass = {
    labelExpressionInfo: { expression: "$feature.CTY_NAME" },
    symbol: { type:"text", color:"black", haloColor:"white", haloSize:"1.5px", font:{family:"Arial", size:7, weight:"bold"} },
    minScale:3000000, maxScale:0
  };

  /* status colors */
  const statusColors = {
    "Pending Review":"#bc143c",
    "Denied - Unable to Fill":"#FF0000",
    "Needs More Information":"#f58231",
    "Approved - Awaiting Assignment":"#ffe119",
    "Assigned":"#bfef45",
    "Resource Committed":"#3cb44b",
    "En-Route":"#42d4f4",
    "On-Scene":"#4363d8",
    "Demobilized":"#42d4f4",
    "Completed":"#000075",
    "Cancelled":"#000000"
  };

  /* popup template for all layers */
  const resourcePopup = {
    title: "{resource_status}",
    content: `
      <ul>
        <li><strong>Requesting Agency:</strong> {req_agency}</li>
        <li><strong>Resource Requested:</strong> {resource_requested}</li>
        <li><strong>Quantity:</strong> {resource_qty}</li>
        <li><strong>Entry Date:</strong> {resource_request_entry_date}</li>
        <li><strong>Due Date:</strong> {resource_req_due_date}</li>
        <li><strong>Assigned To:</strong> {resource_req_assigned_to}</li>
      </ul>
    `
  };

  /* dashboard tab layers */
  const dashboardCounties = new FeatureLayer({
    url:"https://services5.arcgis.com/Ul9AyFFeFTjf08DW/arcgis/rest/services/Wisconsin_County_Boundaries_24K/FeatureServer/0",
    title:"County Boundaries",
    renderer: countyBoundaryRenderer,
    labelingInfo: [countyLabelClass],
    opacity: 1
  });

  const dashboardLayer = new FeatureLayer({
    url: "https://services.arcgis.com/HRPe58bUyBqyyiCt/arcgis/rest/services/Resource_Request_Database_Dashboard/FeatureServer",
    renderer: {
      type:"unique-value",
      field:"resource_status",
      uniqueValueInfos: Object.entries(statusColors).map(([status,color])=>{
        return { value: status, symbol:{ type:"simple-marker", color:color, size:10, outline:{color:"white", width:1}} };
      })
    },
    outFields:["resource_status","req_agency","resource_requested","resource_qty","resource_request_entry_date","resource_req_due_date","resource_req_assigned_to"],
    popupTemplate: resourcePopup
  });
 //dashboard base map
  const dashboardView = new MapView({
    container:"viewDiv1",
    map:new Map({ basemap:"gray-vector", layers:[dashboardCounties, dashboardLayer] }),
    center:[-89.5,44.5], zoom:6
  });
  views["dashboard"] = dashboardView;

  const statusesDashboard = ["Pending Review","Needs More Information","Assigned","Resource Committed","En-Route","On-Scene"];
  const countBoxesDashboard = document.getElementById("countBoxesDashboard");

  function updateCountsDashboard(){
    countBoxesDashboard.innerHTML = "";
    statusesDashboard.forEach(status=>{
      const query = dashboardLayer.createQuery();
      query.where = `resource_status='${status}'`;
      dashboardLayer.queryFeatureCount(query).then(count=>{
        const box = document.createElement("div");
        box.className = "countBox";
        box.style.background = statusColors[status];
        box.innerHTML = `<div>${status}</div><div>${count}</div>`;
        countBoxesDashboard.appendChild(box);
      });
    });
  }

  dashboardView.whenLayerView(dashboardLayer).then(()=>updateCountsDashboard());

  // pending review tab layers//
  const pendingCounties = new FeatureLayer({
    url:"https://services5.arcgis.com/Ul9AyFFeFTjf08DW/arcgis/rest/services/Wisconsin_County_Boundaries_24K/FeatureServer/0",
    title:"County Boundaries",
    renderer: countyBoundaryRenderer,
    labelingInfo: [countyLabelClass],
    opacity: 1
  });

  const pendingLayer = new FeatureLayer({
    url:"https://services.arcgis.com/HRPe58bUyBqyyiCt/arcgis/rest/services/Resource_Request_Reviewer_Layer/FeatureServer",
    outFields: ["resource_req_due_date","resource_status","req_agency","resource_requested","resource_qty","resource_request_entry_date","resource_req_assigned_to"],
    popupTemplate: resourcePopup
  });
  //pending review base map
  const pendingView = new MapView({
    container:"viewDiv2",
    map:new Map({ basemap:"gray-vector", layers:[pendingCounties, pendingLayer]}),
    center:[-89.5,44.5], zoom:6
  });
  views["pending"] = pendingView;

  const pendingEditor = new Editor({ view: pendingView, layerInfos:[{layer:pendingLayer, enableEditing:true, enableCreate:true, enableUpdate:true, enableDelete:true}]});
  pendingView.ui.add(pendingEditor,"top-right");

  const countBoxesPending = document.getElementById("countBoxesPending");

  function updateOverduePending() {
    const now = new Date();
    const query = pendingLayer.createQuery();
    query.where = `resource_status='Pending Review'`;
    query.outFields = ["resource_req_due_date"];

    pendingLayer.queryFeatures(query).then(result => {
      let overdueCount = 0;
      const overdueIds = [];

      result.features.forEach(f => {
        const dueDate = new Date(f.attributes.resource_req_due_date);
        if(dueDate < now) {
          overdueCount++;
          overdueIds.push(f.attributes.OBJECTID);
        }
      });

      // update count box
      countBoxesPending.innerHTML = "";
      const box = document.createElement("div");
      box.className = "countBox";
      box.style.background = "#bc143c"; // red for overdue
      box.innerHTML = `<div>Overdue</div><div>${overdueCount}</div>`;
      countBoxesPending.appendChild(box);

      // update renderer with overdue highlight
      pendingLayer.renderer = {
        type: "unique-value",
        field: "resource_status",
        defaultSymbol: {
          type: "simple-marker",
          color: statusColors["Pending Review"],
          size: 10,
          outline: { color: "white", width: 1 }
        },
        uniqueValueInfos: [
          {
            value: "Pending Review",
            symbol: {
              type: "simple-marker",
              color: "#ff0000",
              size: 14,
              outline: { color: "white", width: 1 }
            },
            label: "Overdue"
          }
        ]
      };
    });
  }

  pendingView.whenLayerView(pendingLayer).then(() => {
    updateOverduePending();
    setInterval(updateOverduePending, 60000);
  });

  /* assigned tab layers */
    const assignedCounties = new FeatureLayer({
    url:"https://services5.arcgis.com/Ul9AyFFeFTjf08DW/arcgis/rest/services/Wisconsin_County_Boundaries_24K/FeatureServer/0",
    title:"County Boundaries",
    renderer: countyBoundaryRenderer,
    labelingInfo: [countyLabelClass],
    opacity: 1
    });

    // marker colors match dashboard tab colors
    const assignedLayer = new FeatureLayer({
    url:"https://services.arcgis.com/HRPe58bUyBqyyiCt/arcgis/rest/services/Resource_Request_Database_Assigned/FeatureServer",
    renderer: {
        type: "unique-value",
        field: "resource_status",
          uniqueValueInfos: Object.entries(statusColors)
          .filter(([status]) => status !== "Denied - Unable to Fill")
          .map(([status, color]) => ({
            value: status,
            symbol: {
              type: "simple-marker",
              color: color,
              size: 10,
              outline: { color: "white", width: 1 }
            }
          }))
    },
    outFields:["resource_status","req_agency","resource_requested","resource_qty","resource_request_entry_date","resource_req_due_date","resource_req_assigned_to"],
    popupTemplate: resourcePopup
    });
//assigned base map
  const assignedView = new MapView({
    container:"viewDiv3",
    map:new Map({ basemap:"gray-vector", layers:[assignedCounties, assignedLayer]}),
    center:[-89.5,44.5], zoom:6
  });
  views["assigned"]=assignedView;

  const assignedEditor = new Editor({ view: assignedView, layerInfos:[{layer:assignedLayer, enableEditing:true, enableCreate:true, enableUpdate:true, enableDelete:true}]});
  assignedView.ui.add(assignedEditor,"top-right");

  assignedView.whenLayerView(assignedLayer).then(layerView=>{
    assignedLayer.queryFeatures({where:"1=1", outFields:["resource_req_assigned_to"], returnDistinctValues:true})
    .then(result=>{
      const select=document.getElementById("assignedSelect");
      const uniqueVals = new Set();
      result.features.forEach(f=>{
        const val=f.attributes.resource_req_assigned_to;
        if(val && !uniqueVals.has(val)){
          uniqueVals.add(val);
          const option=document.createElement("option");
          option.value=val; option.text=val;
          select.appendChild(option);
        }
      });
    });

    document.getElementById("assignedSelect").addEventListener("change",(evt)=>{
      const value=evt.target.value;
      assignedLayer.definitionExpression=value? `resource_req_assigned_to='${value}'` : "";
    });
  });

  /* completed tab layers */
const completedCounties = new FeatureLayer({
  url: "https://services5.arcgis.com/Ul9AyFFeFTjf08DW/arcgis/rest/services/Wisconsin_County_Boundaries_24K/FeatureServer/0",
  title: "County Boundaries",
  renderer: countyBoundaryRenderer,
  labelingInfo: [countyLabelClass],
  opacity: 1
});

//statuses for completed tab
const completedStatuses = ["Completed", "Cancelled", "Denied - Unable to Fill"];

// completed tab layers
const completedLayer = new FeatureLayer({
  url: "https://services.arcgis.com/HRPe58bUyBqyyiCt/arcgis/rest/services/Resource_Request_Database_Completed/FeatureServer",
  renderer: {
    type: "unique-value",
    field: "resource_status",
    uniqueValueInfos: completedStatuses.map(status => ({
      value: status,
      symbol: {
        type: "simple-marker",
        color: statusColors[status],
        size: 10,
        outline: { color: "white", width: 1 }
      }
    }))
  },
  outFields: [
    "resource_status",
    "req_agency",
    "resource_requested",
    "resource_qty",
    "resource_request_entry_date",
    "resource_req_due_date",
    "resource_req_assigned_to"
  ],
  popupTemplate: resourcePopup
});

//completed basemap view
const completedView = new MapView({
  container: "viewDiv4",
  map: new Map({
    basemap: "gray-vector",
    layers: [completedCounties, completedLayer]
  }),
  center: [-89.5, 44.5],
  zoom: 6
});
views["completed"] = completedView;

// count boxes
const countBoxesCompleted = document.getElementById("countBoxesCompleted");

function updateCountsCompleted() {
  countBoxesCompleted.innerHTML = "";
  completedStatuses.forEach(status => {
    const query = completedLayer.createQuery();
    query.where = `resource_status='${status}'`;
    completedLayer.queryFeatureCount(query).then(count => {
      const box = document.createElement("div");
      box.className = "countBox";
      box.style.background = statusColors[status];
      box.innerHTML = `<div>${status}</div><div>${count}</div>`;
      countBoxesCompleted.appendChild(box);
    });
  });
}

completedView.whenLayerView(completedLayer).then(() => updateCountsCompleted());

});
</script>
</body>
</html>
