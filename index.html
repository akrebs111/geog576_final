<!--Created by Alex Krebs-->
<!--Geog576 Final Project-->
<!--Resource Request Full Stack Application-->

<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Resource Request Dashboard</title>
<style>
body { margin: 0; font-family: Arial; }

/*tabs*/
.tab { display: flex; background: #0079c1; }
.tab button { background: inherit; border: none; outline: none; cursor: pointer; padding: 14px 20px; color: white; font-size: 16px; }
.tab button.active { background: #005a87; }

/*resource request form*/
.survey-btn { margin-left: auto; background: #28a745 !important; color: white; border: none; padding: 14px 20px; cursor: pointer; font-size: 16px; }
.survey-btn:hover { background: #1e7e34 !important; }

/* help button */
.help-btn { background: #555 !important; color: white; border: none; padding: 14px 20px; cursor: pointer; font-size: 16px; margin-left: 8px; }
.help-btn:hover { background: #333 !important; }

/* tab container */
.tabcontent { display: none; height: calc(100vh - 52px); width: 100%; position: relative; }
.mapContainer { height: 100%; width: 100%; }

/* indicator boxes */
.countBoxes {
  position: absolute;
  bottom: 0;
  left: 0;
  width: 100%;
  display: flex;
  justify-content: space-around;
  background: rgba(255,255,255,0.9);
  padding: 12px 0;
  box-shadow: 0 -2px 4px rgba(0,0,0,0.3);
  font-weight: bold;
  font-size: 20px;
}

.countBox {
  color: white;
  padding: 16px 24px;
  border-radius: 6px;
  text-align: center;
  min-width: 160px;
}

/* filter for eoc positions */
#assignedFilter {
  position: absolute;
  top: 10px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 1000; 
  background: white;
  padding: 16px;
  border-radius: 6px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.3);
  font-size: 18px;
}
#assignedFilter label { margin-right: 8px; font-weight: bold; font-size: 18px; }
#assignedFilter select { font-size: 18px; padding: 6px; }

/* splash popup */
#splashModal {
  display: none;
  position: fixed;
  z-index: 2000;
  left: 0; top: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.5);
  justify-content: center;
  align-items: center;
}
#splashModal.active {
  display: flex;
}
#splashContent {
  background: white;
  padding: 24px 32px;
  border-radius: 8px;
  max-width: 400px;
  box-shadow: 0 0 15px rgba(0,0,0,0.3);
  position: relative;
  font-size: 18px;
  color: #222;
  line-height: 1.4;
}
#splashCloseBtn {
  position: absolute;
  top: 8px; right: 8px;
  background: #bc143c;
  border: none;
  color: white;
  font-size: 20px;
  cursor: pointer;
  border-radius: 50%;
  width: 32px;
  height: 32px;
  line-height: 30px;
  text-align: center;
}
#splashCloseBtn:hover {
  background: #910f2e;
}
</style>

<link rel="stylesheet" href="https://js.arcgis.com/4.26/esri/themes/light/main.css" />
<script src="https://js.arcgis.com/4.26/"></script>
</head>

<body>

<div class="tab">
  <button class="tablink active" onclick="openTab(event, 'dashboard')">Resource Request Dashboard</button>
  <button class="tablink" onclick="openTab(event, 'pending')">Pending Review</button>
  <button class="tablink" onclick="openTab(event, 'assigned')">Assigned</button>
  <button class="tablink" onclick="openTab(event, 'completed')">Completed</button>
  <button class="survey-btn" onclick="window.open('https://survey123.arcgis.com/share/14b60521f4b843239d951fa1ce3a6f57','_blank')">Resource Request Form</button>
  <button class="help-btn" id="helpBtn">Help</button>
</div>

<!-- resource request dashboard tab -->
<div id="dashboard" class="tabcontent" style="display:block;">
  <div id="viewDiv1" class="mapContainer"></div>
  <div id="countBoxesDashboard" class="countBoxes"></div>
</div>

<!-- pending review tab -->
<div id="pending" class="tabcontent">
  <div id="viewDiv2" class="mapContainer"></div>
  <div id="countBoxesPending" class="countBoxes"></div>
</div>

<!-- assigned tab -->
<div id="assigned" class="tabcontent">
  <div id="viewDiv3" class="mapContainer"></div>
  <div id="assignedFilter">
    <label for="assignedSelect">Select EOC Position:</label>
    <select id="assignedSelect">
      <option value="">-- All --</option>
    </select>
  </div>
</div>

<!-- completed tab -->
<div id="completed" class="tabcontent">
  <div id="viewDiv4" class="mapContainer"></div>
  <div id="countBoxesCompleted" class="countBoxes"></div>
</div>

<!-- splash popup -->
<div id="splashModal" role="dialog" aria-modal="true" aria-labelledby="splashTitle" tabindex="-1">
  <div id="splashContent">
    <button id="splashCloseBtn" aria-label="Close Help">&times;</button>
    <h2 id="splashTitle" style="text-align:center;">Welcome to the Resource Request Tracking, Assignment, and Approval Application</h2>
    <ul>
      <li>Use the <strong>Resource Request Dashboard</strong> to view requested resources.</li>
      <li>The <strong>Pending Review</strong> tab is for EOC Resource section members to verify and assign resource requests.</li>
      <li>The <strong>Assigned</strong> tab allows EOC positions to filter their position and edit any resource requests they may be assigned.</li>
      <li>The <strong>Completed</strong> tab tracks any resources that have been completed, approved, or denied.</li>
      <li>Resource requests can be manually entered by clicking the <strong>Resource Request Form</strong> button.</li>
    </ul>
  </div>
</div>

<script>
function openTab(evt, tabName){
  document.querySelectorAll(".tabcontent").forEach(div => div.style.display='none');
  document.querySelectorAll(".tablink").forEach(btn => btn.classList.remove('active'));
  document.getElementById(tabName).style.display='block';
  evt.currentTarget.classList.add('active');
  if(views[tabName]) views[tabName].resize();
}

// splash popup show/hide
const splashModal = document.getElementById("splashModal");
const helpBtn = document.getElementById("helpBtn");
const splashCloseBtn = document.getElementById("splashCloseBtn");

helpBtn.addEventListener("click", () => {
  splashModal.classList.add("active");
  splashModal.focus();
});
splashCloseBtn.addEventListener("click", () => {
  splashModal.classList.remove("active");
});
splashModal.addEventListener("click", (evt) => {
  if(evt.target === splashModal){
    splashModal.classList.remove("active");
  }
});

require([
  "esri/Map",
  "esri/views/MapView",
  "esri/layers/FeatureLayer",
  "esri/widgets/Editor"
], function(Map, MapView, FeatureLayer, Editor){

  window.views = {};

  /* county boundary */
  const countyBoundaryRenderer = {
    type: "simple",
    symbol: { type: "simple-fill", color: [0,0,0,0], outline:{color:"black", width:0.5, style:"dash"} }
  };
  const countyLabelClass = {
    labelExpressionInfo: { expression: "$feature.CTY_NAME" },
    symbol: { type:"text", color:"black", haloColor:"white", haloSize:"1.5px", font:{family:"Arial", size:7, weight:"bold"} },
    minScale:3000000, maxScale:0
  };

  /* status colors */
  const statusColors = {
    "Pending Review":"#bc143c",
    "Denied - Unable to Fill":"#000000",
    "Needs More Information":"#f58231",
    "Approved - Awaiting Assignment":"#ffe119",
    "Assigned":"#bfef45",
    "Resource Committed":"#3cb44b",
    "En-Route":"#42d4f4",
    "On-Scene":"#4363d8",
    "Demobilized":"#42d4f4",
    "Completed":"#000075",
    "Cancelled":"#000000"
  };

  /* popup template for all layers */
  const resourcePopup = {
    title: "{resource_status}",
    content: `
      <ul>
        <li><strong>Requesting Agency:</strong> {req_agency}</li>
        <li><strong>Resource Requested:</strong> {resource_requested}</li>
        <li><strong>Quantity:</strong> {resource_qty}</li>
        <li><strong>Entry Date:</strong> {resource_request_entry_date}</li>
        <li><strong>Due Date:</strong> {resource_req_due_date}</li>
        <li><strong>Assigned To:</strong> {resource_req_assigned_to}</li>
      </ul>
    `
  };

  /* dashboard tab layers */
  const dashboardCounties = new FeatureLayer({
    url:"https://services5.arcgis.com/Ul9AyFFeFTjf08DW/arcgis/rest/services/Wisconsin_County_Boundaries_24K/FeatureServer/0",
    title:"County Boundaries",
    renderer: countyBoundaryRenderer,
    labelingInfo: [countyLabelClass],
    opacity: 1
  });

  const dashboardLayer = new FeatureLayer({
    url: "https://services.arcgis.com/HRPe58bUyBqyyiCt/arcgis/rest/services/Resource_Request_Database_Dashboard/FeatureServer",
    renderer: {
      type:"unique-value",
      field:"resource_status",
      uniqueValueInfos: Object.entries(statusColors).map(([status,color])=>{
        return { value: status, symbol:{ type:"simple-marker", color:color, size:10, outline:{color:"white", width:1}} };
      })
    },
    outFields:["resource_status","req_agency","resource_requested","resource_qty","resource_request_entry_date","resource_req_due_date","resource_req_assigned_to"],
    popupTemplate: resourcePopup
  });

  const dashboardView = new MapView({
    container:"viewDiv1",
    map:new Map({ basemap:"gray-vector", layers:[dashboardCounties, dashboardLayer] }),
    center:[-89.5,44.5], zoom:6
  });
  views["dashboard"] = dashboardView;

  const statusesDashboard = ["Pending Review","Needs More Information","Assigned","Resource Committed","En-Route","On-Scene"];
  const countBoxesDashboard = document.getElementById("countBoxesDashboard");

  function updateCountsDashboard(){
    countBoxesDashboard.innerHTML = "";
    statusesDashboard.forEach(status=>{
      const query = dashboardLayer.createQuery();
      query.where = `resource_status='${status}'`;
      dashboardLayer.queryFeatureCount(query).then(count=>{
        const box = document.createElement("div");
        box.className = "countBox";
        box.style.background = statusColors[status];
        box.innerHTML = `<div>${status}</div><div>${count}</div>`;
        countBoxesDashboard.appendChild(box);
      });
    });
  }

  dashboardView.whenLayerView(dashboardLayer).then(()=>updateCountsDashboard());

  /* pending review tab layers*/
  const pendingCounties = new FeatureLayer({
    url:"https://services5.arcgis.com/Ul9AyFFeFTjf08DW/arcgis/rest/services/Wisconsin_County_Boundaries_24K/FeatureServer/0",
    title:"County Boundaries",
    renderer: countyBoundaryRenderer,
    labelingInfo: [countyLabelClass],
    opacity: 1
  });

  const pendingLayer = new FeatureLayer({
    url:"https://services.arcgis.com/HRPe58bUyBqyyiCt/arcgis/rest/services/Resource_Request_Reviewer_Layer/FeatureServer",
    outFields: ["resource_req_due_date","resource_status","req_agency","resource_requested","resource_qty","resource_request_entry_date","resource_req_assigned_to"],
    popupTemplate: resourcePopup
  });

  const pendingView = new MapView({
    container:"viewDiv2",
    map:new Map({ basemap:"gray-vector", layers:[pendingCounties, pendingLayer]}),
    center:[-89.5,44.5], zoom:6
  });
  views["pending"] = pendingView;

  const pendingEditor = new Editor({ view: pendingView, layerInfos:[{layer:pendingLayer, enableEditing:true, enableCreate:true, enableUpdate:true, enableDelete:true}]});
  pendingView.ui.add(pendingEditor,"top-right");

  const countBoxesPending = document.getElementById("countBoxesPending");

  function updateOverduePending() {
    const now = new Date();
    const query = pendingLayer.createQuery();
    query.where = `resource_status='Pending Review'`;
    query.outFields = ["resource_req_due_date"];

    pendingLayer.queryFeatures(query).then(result => {
      let overdueCount = 0;
      const overdueIds = [];

      result.features.forEach(f => {
        const dueDate = new Date(f.attributes.resource_req_due_date);
        if(dueDate < now) {
          overdueCount++;
          overdueIds.push(f.attributes.OBJECTID);
        }
      });

      // update count box
      countBoxesPending.innerHTML = "";
      const box = document.createElement("div");
      box.className = "countBox";
      box.style.background = "#bc143c"; // red for overdue
      box.innerHTML = `<div>Overdue</div><div>${overdueCount}</div>`;
      countBoxesPending.appendChild(box);

      // update renderer with overdue highlight
      pendingLayer.renderer = {
        type: "unique-value",
        field: "resource_status",
        defaultSymbol: {
          type: "simple-marker",
          color: statusColors["Pending Review"],
          size: 10,
          outline: { color: "white", width: 1 }
        },
        uniqueValueInfos: [
          {
            value: "Pending Review",
            symbol: {
              type: "simple-marker",
              color: "#ff0000",
              size: 14,
              outline: { color: "white", width: 1 }
            },
            label: "Overdue"
          }
        ]
      };
    });
  }

  pendingView.whenLayerView(pendingLayer).then(() => {
    updateOverduePending();
    setInterval(updateOverduePending, 60000);
  });

  /* assigned tab layers */
    const assignedCounties = new FeatureLayer({
    url:"https://services5.arcgis.com/Ul9AyFFeFTjf08DW/arcgis/rest/services/Wisconsin_County_Boundaries_24K/FeatureServer/0",
    title:"County Boundaries",
    renderer: countyBoundaryRenderer,
    labelingInfo: [countyLabelClass],
    opacity: 1
    });

    // marker colors match dashboard tab colors
    const assignedLayer = new FeatureLayer({
    url:"https://services.arcgis.com/HRPe58bUyBqyyiCt/arcgis/rest/services/Resource_Request_Database_Assigned/FeatureServer",
    renderer: {
        type: "unique-value",
        field: "resource_status",
        uniqueValueInfos: Object.entries(statusColors).map(([status, color]) => {
        return {
            value: status,
            symbol: {
            type: "simple-marker",
            color: color,
            size: 10,
            outline: { color: "white", width: 1 }
            }
        };
        })
    },
    outFields:["resource_status","req_agency","resource_requested","resource_qty","resource_request_entry_date","resource_req_due_date","resource_req_assigned_to"],
    popupTemplate: resourcePopup
    });

  const assignedView = new MapView({
    container:"viewDiv3",
    map:new Map({ basemap:"gray-vector", layers:[assignedCounties, assignedLayer]}),
    center:[-89.5,44.5], zoom:6
  });
  views["assigned"]=assignedView;

  const assignedEditor = new Editor({ view: assignedView, layerInfos:[{layer:assignedLayer, enableEditing:true, enableCreate:true, enableUpdate:true, enableDelete:true}]});
  assignedView.ui.add(assignedEditor,"top-right");

  assignedView.whenLayerView(assignedLayer).then(layerView=>{
    assignedLayer.queryFeatures({where:"1=1", outFields:["resource_req_assigned_to"], returnDistinctValues:true})
    .then(result=>{
      const select=document.getElementById("assignedSelect");
      const uniqueVals = new Set();
      result.features.forEach(f=>{
        const val=f.attributes.resource_req_assigned_to;
        if(val && !uniqueVals.has(val)){
          uniqueVals.add(val);
          const option=document.createElement("option");
          option.value=val; option.text=val;
          select.appendChild(option);
        }
      });
    });

    document.getElementById("assignedSelect").addEventListener("change",(evt)=>{
      const value=evt.target.value;
      assignedLayer.definitionExpression=value? `resource_req_assigned_to='${value}'` : "";
    });
  });

  /* completed tab layers */
  const completedCounties = new FeatureLayer({
    url:"https://services5.arcgis.com/Ul9AyFFeFTjf08DW/arcgis/rest/services/Wisconsin_County_Boundaries_24K/FeatureServer/0",
    title:"County Boundaries",
    renderer: countyBoundaryRenderer,
    labelingInfo: [countyLabelClass],
    opacity: 1
  });

  const completedLayer = new FeatureLayer({
    url:"https://services.arcgis.com/HRPe58bUyBqyyiCt/arcgis/rest/services/Resource_Request_Database_Completed/FeatureServer",
    renderer:{ type:"simple", symbol:{ type:"simple-marker", color:statusColors["Completed"], size:10, outline:{color:"white", width:1}} },
    outFields:["resource_status","req_agency","resource_requested","resource_qty","resource_request_entry_date","resource_req_due_date","resource_req_assigned_to"],
    popupTemplate: resourcePopup
  });

  const completedView = new MapView({
    container:"viewDiv4",
    map:new Map({ basemap:"gray-vector", layers:[completedCounties, completedLayer]}),
    center:[-89.5,44.5], zoom:6
  });
  views["completed"]=completedView;

  const statusesCompleted=["Completed","Cancelled"];
  const countBoxesCompleted=document.getElementById("countBoxesCompleted");
  function updateCountsCompleted(){
    countBoxesCompleted.innerHTML="";
    statusesCompleted.forEach(status=>{
      const query=completedLayer.createQuery();
      query.where=`resource_status='${status}'`;
      completedLayer.queryFeatureCount(query).then(count=>{
        const box=document.createElement("div");
        box.className="countBox";
        box.style.background=statusColors[status];
        box.innerHTML=`<div>${status}</div><div>${count}</div>`;
        countBoxesCompleted.appendChild(box);
      });
    });
  }
  completedView.whenLayerView(completedLayer).then(()=>updateCountsCompleted());

});
</script>
</body>
</html>
